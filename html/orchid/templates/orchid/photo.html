{% extends "orchid/base_layout.html" %}

{% block title %}Photo Identity | OrchID{% endblock %}

{% block content %}
<h1>Photo Identity</h1>

<p>
    <div id="identity"></div>
</p>

<div id="species-info"></div>

<h2>Photo</h2>

<p>
    <img src="{{ photo.image.url }}" id="photo" class="img-responsive img-rounded" alt="{{ photo.file_name }}">
</p>

<div class="btn-group">
    <button class="btn btn-default" data-href="{% url 'orchid:identify' photo.id %}"><i class="fa fa-search fa-fw"></i> Re-identify</button>
    <button class="btn btn-default" data-toggle="modal" data-target="#delete-modal"><i class="fa fa-trash fa-fw"></i> Delete</button>
</div>

<!-- Modals -->
<div class="modal" id="delete-modal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <h4 class="modal-title">Delete Photo</h4>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to <strong>permanently</strong> delete this
        photo? This action cannot be undone.</p>

        <div id="delete-modal-message"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" data-action="delete-photo">Delete</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
jQuery(function( $ ) {
    // Load the photo identities.
    $("#identity").html('<div class="alert alert-info" role="alert"><i class="fa fa-gear fa-fw"></i> Please wait while we identify your photo...</div>');

    $.ajax({
        url: "{% url 'orchid:identity' photo.id %}",
        dataType: "html"
    }).done(function(data) {
        var species;

        // Display the result.
        $("#identity").html(data);

        // Set the species button actions.
        $("button[data-identity]").click(function() {
            $("#species-info").html('<div class="alert alert-info" role="alert">Fetching species info from the Encyclopedia of Life...</div>');

            identity_pk = $(this).data("identity");
            $.ajax({
                url: "{% url 'orchid:api:identity-info' '000' %}".replace('000', identity_pk),
                dataType: "html",
                success: function(data) {
                    $("#species-info").html(data);
                },
                error: function(data) {
                    $("#species-info").html('<div class="alert alert-danger" role="alert">Failed to obtain species info.</div>');
                }
            });
        });
    });

    $("button[data-action='delete-photo']").click(function(event) {
        $.ajax({
            url: "{% url 'orchid:delete_photo' photo.id %}",
            dataType: "json",
            success: function(data) {
                window.location.href = "{% url 'orchid:library' %}";
            },
            error: function(data) {
                $("#delete-modal-message").html('<p class="text-danger">' +
                    '<strong>Oops!</strong> An error occurred and the photo ' +
                    'could not be deleted. Please contact the admin about ' +
                    'this problem.</p>');
            }
        });
    });

});
</script>
{% endblock %}
